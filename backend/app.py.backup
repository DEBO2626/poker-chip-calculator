"""
Flask Backend for Poker Chip Calculator
Converts the Python calculator into a REST API for web/mobile access
"""

from flask import Flask, request, jsonify, send_from_directory
from flask_cors import CORS
import os
import sys

# Import the calculator functions
from pokerchipcounter import (
    calculate_chip_distribution,
    calculate_chip_distribution_custom,
    load_chip_set
)

# Initialize Flask app
app = Flask(__name__, static_folder='../frontend', static_url_path='')
CORS(app)  # Enable CORS for frontend to call backend

# Load chip set once at startup
try:
    CHIP_SET = load_chip_set()
    print("[OK] Chip set loaded successfully")
except Exception as e:
    print(f"[WARNING] Could not load chip set from file: {e}")
    # Use default chip set
    CHIP_SET = {
        1: 300,
        5: 200,
        25: 200,
        100: 200,
        500: 50,
        1000: 50
    }
    print("[OK] Using default chip set")


# ============================================================================
# API ENDPOINTS
# ============================================================================

@app.route('/')
def serve_frontend():
    """Serve the main HTML page"""
    return send_from_directory(app.static_folder, 'index.html')


@app.route('/api/health', methods=['GET'])
def health_check():
    """Health check endpoint - verify API is running"""
    return jsonify({
        'status': 'healthy',
        'message': 'Poker Chip Calculator API is running',
        'version': '2.1'
    })


@app.route('/api/chip-set', methods=['GET'])
def get_chip_set():
    """Get available chip set inventory"""
    total_value = sum(denom * count for denom, count in CHIP_SET.items())
    return jsonify({
        'chip_set': CHIP_SET,
        'total_value': total_value,
        'total_chips': sum(CHIP_SET.values())
    })


@app.route('/api/calculate', methods=['POST'])
def calculate_auto():
    """
    Mode 1: Auto-calculate chip distribution based on tournament duration

    Expected JSON body:
    {
        "num_players": 12,
        "small_blind": 25,
        "big_blind": 50,
        "duration_hours": 5,
        "minutes_per_level": 15
    }
    """
    try:
        data = request.json

        # Validate required fields
        required_fields = ['num_players', 'small_blind', 'big_blind',
                          'duration_hours', 'minutes_per_level']
        for field in required_fields:
            if field not in data:
                return jsonify({
                    'error': f'Missing required field: {field}'
                }), 400

        # Extract parameters
        num_players = int(data['num_players'])
        small_blind = float(data['small_blind'])
        big_blind = float(data['big_blind'])
        duration_hours = float(data['duration_hours'])
        minutes_per_level = int(data['minutes_per_level'])

        # Call calculator
        result = calculate_chip_distribution(
            num_players=num_players,
            small_blind=small_blind,
            big_blind=big_blind,
            duration_hours=duration_hours,
            minutes_per_level=minutes_per_level
        )

        # Check if result has error
        if 'error' in result:
            return jsonify(result), 400

        return jsonify(result)

    except ValueError as e:
        return jsonify({
            'error': str(e)
        }), 400
    except Exception as e:
        return jsonify({
            'error': f'Unexpected error: {str(e)}'
        }), 500


@app.route('/api/calculate-custom', methods=['POST'])
def calculate_custom():
    """
    Mode 2: Calculate chip distribution for custom stack size

    Expected JSON body:
    {
        "num_players": 10,
        "small_blind": 25,
        "big_blind": 50,
        "target_stack": 8500
    }
    """
    try:
        data = request.json

        # Validate required fields
        required_fields = ['num_players', 'small_blind', 'big_blind', 'target_stack']
        for field in required_fields:
            if field not in data:
                return jsonify({
                    'error': f'Missing required field: {field}'
                }), 400

        # Extract parameters
        num_players = int(data['num_players'])
        small_blind = float(data['small_blind'])
        big_blind = float(data['big_blind'])
        target_stack = float(data['target_stack'])

        # Call calculator
        result = calculate_chip_distribution_custom(
            num_players=num_players,
            small_blind=small_blind,
            big_blind=big_blind,
            target_stack=target_stack
        )

        # Check if result has error
        if 'error' in result:
            return jsonify(result), 400

        return jsonify(result)

    except ValueError as e:
        return jsonify({
            'error': str(e)
        }), 400
    except Exception as e:
        return jsonify({
            'error': f'Unexpected error: {str(e)}'
        }), 500


@app.route('/api/verify-license', methods=['POST'])
def verify_license():
    """
    Verify Gumroad license key

    Expected JSON body:
    {
        "license_key": "XXXX-XXXX-XXXX-XXXX",
        "product_id": "your_gumroad_product_id"
    }
    """
    try:
        data = request.json
        license_key = data.get('license_key')
        product_id = data.get('product_id')

        if not license_key or not product_id:
            return jsonify({
                'success': False,
                'error': 'Missing license_key or product_id'
            }), 400

        # TODO: Implement Gumroad API verification
        # For now, return a placeholder response
        # This will be implemented when we integrate Gumroad in Phase 6

        return jsonify({
            'success': False,
            'error': 'License verification not yet implemented',
            'message': 'This will be added in Phase 6'
        })

    except Exception as e:
        return jsonify({
            'success': False,
            'error': str(e)
        }), 500


# ============================================================================
# ERROR HANDLERS
# ============================================================================

@app.errorhandler(404)
def not_found(error):
    """Handle 404 errors"""
    return jsonify({
        'error': 'Endpoint not found',
        'message': 'The requested API endpoint does not exist'
    }), 404


@app.errorhandler(500)
def internal_error(error):
    """Handle 500 errors"""
    return jsonify({
        'error': 'Internal server error',
        'message': 'An unexpected error occurred on the server'
    }), 500


# ============================================================================
# MAIN
# ============================================================================

if __name__ == '__main__':
    print("\n" + "="*60)
    print("POKER CHIP CALCULATOR API")
    print("="*60)
    print(f"[OK] Chip set loaded: {len(CHIP_SET)} denominations")
    print(f"[OK] Total chip value: ${sum(denom * count for denom, count in CHIP_SET.items()):,}")
    print("\n[SERVER] Starting server...")
    print("   Local:   http://localhost:5000")
    print("   Network: http://192.168.x.x:5000 (check your local IP)")
    print("\n[API] Endpoints:")
    print("   GET  /api/health          - Health check")
    print("   GET  /api/chip-set        - Get chip inventory")
    print("   POST /api/calculate       - Mode 1 (auto-calculate)")
    print("   POST /api/calculate-custom - Mode 2 (custom stack)")
    print("   POST /api/verify-license  - Verify Gumroad license")
    print("\n[INFO] Press CTRL+C to stop the server")
    print("="*60 + "\n")

    # Run the Flask development server
    app.run(
        host='0.0.0.0',  # Listen on all network interfaces
        port=5000,
        debug=True  # Enable debug mode for development
    )
